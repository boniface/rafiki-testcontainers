"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.FailureController = void 0;
const packet_1 = require("ilp-protocol-stream/dist/src/packet");
const payment_1 = require("@interledger/pay/dist/src/senders/payment");
const __1 = require("@interledger/pay");
const ilp_packet_1 = require("ilp-packet");
class FailureController {
    applyRequest({ log }) {
        return (reply) => {
            var _a;
            const closeFrame = (_a = reply.frames) === null || _a === void 0 ? void 0 : _a.find((frame) => frame.type === packet_1.FrameType.ConnectionClose ||
                (frame.type === packet_1.FrameType.StreamClose &&
                    frame.streamId.equals(payment_1.PaymentSender.DEFAULT_STREAM_ID)));
            if (closeFrame) {
                log.error('ending payment: receiver closed the connection. reason=%s message="%s"', packet_1.ErrorCode[closeFrame.errorCode], closeFrame.errorMessage);
                return __1.PaymentError.ClosedByReceiver;
            }
            if (!reply.isReject()) {
                return;
            }
            const { code } = reply.ilpReject;
            if (code[0] === 'T' ||
                code === ilp_packet_1.IlpError.F08_AMOUNT_TOO_LARGE ||
                code === ilp_packet_1.IlpError.F99_APPLICATION_ERROR ||
                code === ilp_packet_1.IlpError.R01_INSUFFICIENT_SOURCE_AMOUNT) {
                return;
            }
            log.error('ending payment: %s error', code);
            return __1.PaymentError.ConnectorError;
        };
    }
}
exports.FailureController = FailureController;
//# sourceMappingURL=failure.js.map