{"version":3,"file":"asset-probe.js","sourceRoot":"","sources":["../../../src/senders/asset-probe.ts"],"names":[],"mappings":";;;AAAA,gDAA4D;AAC5D,gEAAmF;AACnF,0BAAiC;AACjC,gEAA+E;AAE/E,gEAAsE;AACtE,kDAAwD;AACxD,sDAAqE;AAErE,wBAAgC;AAIhC,MAAa,UAAW,SAAQ,eAA0B;IAQxD,YAAY,MAAc,EAAE,WAA+B,EAAE,OAAgB;QAC3E,KAAK,CAAC,MAAM,EAAE,WAAW,CAAC,CAAA;QARpB,iBAAY,GAAG,CAAC,CAAA;QAChB,eAAU,GAAG,CAAC,CAAA;QASpB,IAAI,CAAC,uBAAuB,GAAG,IAAI,uCAAuB,CAAC,WAAW,CAAC,CAAA;QACvE,IAAI,CAAC,eAAe,GAAG,IAAI,sCAAsB,CAAC,WAAW,CAAC,CAAA;QAE9D,IAAI,CAAC,WAAW,GAAG;YACjB,IAAI,6BAAkB,CAAC,OAAO,CAAC;YAC/B,IAAI,CAAC,uBAAuB;YAC5B,IAAI,yBAAgB,EAAE;YACtB,IAAI,CAAC,eAAe;SACrB,CAAA;IACH,CAAC;IAGD,SAAS,CAAC,OAAuB;QAC/B,MAAM,YAAY,GAAG,IAAI,CAAC,eAAe,CAAC,mBAAmB,EAAE,CAAA;QAC/D,IAAI,YAAY,EAAE;YAChB,OAAO,uBAAS,CAAC,IAAI,CAAC,YAAY,CAAC,CAAA;SACpC;QAED,IAAI,IAAI,CAAC,YAAY,KAAK,CAAC,EAAE;YAO3B,OAAO,CAAC,SAAS,CAAC,IAAI,kCAAyB,CAAC,EAAE,CAAC,CAAC,CAAC,KAAK,EAAE,CAAA;YAC5D,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,oCAAoC,CAAC,CAAA;SACxD;aAAM,IAAI,IAAI,CAAC,YAAY,KAAK,CAAC,EAAE;YAUlC,MAAM,QAAQ,GAAG,OAAO,CAAC,kBAAkB,CAAC,KAAK,CAAC,GAAG,CAAC,CAAA;YACtD,MAAM,kBAAkB,GAAG,CAAC,GAAG,QAAQ,CAAC,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,EAAE,GAAG,EAAE,GAAG,QAAQ,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC;iBAC9E,IAAI,CAAC,GAAG,CAAC;iBACT,SAAS,CAAC,CAAC,EAAE,IAAI,CAAe,CAAA;YACnC,OAAO;iBACJ,SAAS,CAAC,IAAI,kCAAyB,CAAC,0BAA0B,CAAC,CAAC;iBACpE,qBAAqB,CAAC,kBAAkB,CAAC;iBACzC,KAAK,EAAE,CAAA;YACV,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,oCAAoC,CAAC,CAAA;SACxD;aAAM;YACL,OAAO,uBAAS,CAAC,KAAK,EAAE,CAAA;SACzB;QAED,IAAI,CAAC,YAAY,EAAE,CAAA;QACnB,OAAO,uBAAS,CAAC,IAAI,CAAC,GAAG,EAAE;YACzB,IAAI,CAAC,UAAU,EAAE,CAAA;YACjB,IAAI,IAAI,CAAC,UAAU,KAAK,CAAC,EAAE;gBACzB,OAAO,uBAAS,CAAC,KAAK,EAAE,CAAA;aACzB;YAED,MAAM,UAAU,GAAG,IAAI,CAAC,uBAAuB,CAAC,UAAU,EAAE,CAAA;YAC5D,MAAM,YAAY,GAAG,IAAI,CAAC,eAAe,CAAC,mBAAmB,EAAE,CAAA;YAC/D,OAAO,CAAC,UAAU;gBAChB,CAAC,CAAC,uBAAS,CAAC,KAAK,CAAC,gBAAY,CAAC,mBAAmB,CAAC;gBACnD,CAAC,CAAC,CAAC,YAAY;oBACf,CAAC,CAAC,uBAAS,CAAC,KAAK,CAAC,gBAAY,CAAC,uBAAuB,CAAC;oBACvD,CAAC,CAAC,uBAAS,CAAC,IAAI,CAAC,YAAY,CAAC,CAAA;QAClC,CAAC,CAAC,CAAA;IACJ,CAAC;CACF;AA7ED,gCA6EC","sourcesContent":["import { SendState, StreamController } from '../controllers'\nimport { AssetDetails, AssetDetailsController } from '../controllers/asset-details'\nimport { PaymentError } from '..'\nimport { ConnectionNewAddressFrame } from 'ilp-protocol-stream/dist/src/packet'\nimport { IlpAddress } from 'ilp-packet'\nimport { EstablishmentController } from '../controllers/establishment'\nimport { ExpiryController } from '../controllers/expiry'\nimport { Counter, SequenceController } from '../controllers/sequence'\nimport { Plugin, RequestBuilder } from '../request'\nimport { StreamSender } from '.'\nimport { PaymentDestination } from '../open-payments'\n\n/** Send requests that trigger receiver to respond with asset details */\nexport class AssetProbe extends StreamSender<AssetDetails> {\n  private requestCount = 0\n  private replyCount = 0\n\n  private readonly establishmentController: EstablishmentController\n  private readonly assetController: AssetDetailsController\n  protected readonly controllers: StreamController[]\n\n  constructor(plugin: Plugin, destination: PaymentDestination, counter: Counter) {\n    super(plugin, destination)\n\n    this.establishmentController = new EstablishmentController(destination)\n    this.assetController = new AssetDetailsController(destination)\n\n    this.controllers = [\n      new SequenceController(counter),\n      this.establishmentController,\n      new ExpiryController(),\n      this.assetController,\n    ]\n  }\n\n  // Immediately send two packets to \"request\" the destination asset details\n  nextState(request: RequestBuilder): SendState<AssetDetails> {\n    const assetDetails = this.assetController.getDestinationAsset()\n    if (assetDetails) {\n      return SendState.Done(assetDetails)\n    }\n\n    if (this.requestCount === 0) {\n      /**\n       * `ConnectionNewAddress` with an empty string will trigger `ilp-protocol-stream`\n       * to respond with asset details but *not* trigger a send loop.\n       *\n       * However, Interledger.rs will reject this packet since it considers the frame invalid.\n       */\n      request.addFrames(new ConnectionNewAddressFrame('')).build()\n      request.log.debug('requesting asset details (1 of 2).')\n    } else if (this.requestCount === 1) {\n      /**\n       * `ConnectionNewAddress` with a non-empty string is the only way to trigger Interledger.rs\n       * to respond with asset details.\n       *\n       * But since `ilp-protocol-stream` would trigger a send loop and terminate the payment\n       * to a send-only client, insert a dummy segment before the connection token.\n       * Interledger.rs should handle the packet, but `ilp-protocol-stream` should reject it\n       * without triggering a send loop.\n       */\n      const segments = request.destinationAddress.split('.')\n      const destinationAddress = [...segments.slice(0, -1), '_', ...segments.slice(-1)]\n        .join('.')\n        .substring(0, 1023) as IlpAddress\n      request\n        .addFrames(new ConnectionNewAddressFrame('private.SEND_ONLY_CLIENT'))\n        .setDestinationAddress(destinationAddress)\n        .build()\n      request.log.debug('requesting asset details (2 of 2).')\n    } else {\n      return SendState.Yield()\n    }\n\n    this.requestCount++\n    return SendState.Send(() => {\n      this.replyCount++\n      if (this.replyCount === 1) {\n        return SendState.Yield()\n      }\n\n      const didConnect = this.establishmentController.didConnect()\n      const assetDetails = this.assetController.getDestinationAsset()\n      return !didConnect\n        ? SendState.Error(PaymentError.EstablishmentFailed)\n        : !assetDetails\n        ? SendState.Error(PaymentError.UnknownDestinationAsset)\n        : SendState.Done(assetDetails)\n    })\n  }\n}\n"]}