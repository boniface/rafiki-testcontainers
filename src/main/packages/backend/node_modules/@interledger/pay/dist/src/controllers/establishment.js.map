{"version":3,"file":"establishment.js","sourceRoot":"","sources":["../../../src/controllers/establishment.ts"],"names":[],"mappings":";;;AAAA,wBAAkD;AAGlD,gEAG4C;AAE5C,gDAAkD;AAGlD,MAAa,uBAAuB;IAIlC,YAAY,EAAE,kBAAkB,EAAsB;QAF9C,gBAAW,GAAG,KAAK,CAAA;QAGzB,IAAI,CAAC,kBAAkB,GAAG,kBAAkB,CAAA;IAC9C,CAAC;IAED,UAAU;QACR,OAAO,IAAI,CAAC,WAAW,CAAA;IACzB,CAAC;IAED,YAAY,CAAC,OAAuB;QAClC,OAAO,CAAC,qBAAqB,CAAC,IAAI,CAAC,kBAAkB,CAAC,CAAA;QAEtD,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE;YACrB,OAAO,CAAC,SAAS,CAEf,IAAI,mCAA0B,CAAC,uBAAa,CAAC,iBAAiB,CAAC,EAE/D,IAAI,+BAAsB,CAAC,CAAC,CAAC,CAC9B,CAAA;SACF;QAED,OAAO,eAAY,CAAC,KAAK,EAAE,CAAA;IAC7B,CAAC;IAED,YAAY;QACV,OAAO,CAAC,KAAkB,EAAE,EAAE;YAE5B,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC,WAAW,IAAI,KAAK,CAAC,WAAW,EAAE,CAAA;QAC5D,CAAC,CAAA;IACH,CAAC;CACF;AAjCD,0DAiCC","sourcesContent":["import { RequestState, StreamController } from '.'\nimport { IlpAddress } from 'ilp-packet'\nimport { StreamReply, RequestBuilder } from '../request'\nimport {\n  ConnectionMaxDataFrame,\n  ConnectionMaxStreamIdFrame,\n} from 'ilp-protocol-stream/dist/src/packet'\nimport { PaymentDestination } from '../open-payments'\nimport { PaymentSender } from '../senders/payment'\n\n/** Direct packets to the receiver to establish the connection and share limits */\nexport class EstablishmentController implements StreamController {\n  private readonly destinationAddress: IlpAddress\n  private isConnected = false\n\n  constructor({ destinationAddress }: PaymentDestination) {\n    this.destinationAddress = destinationAddress\n  }\n\n  didConnect(): boolean {\n    return this.isConnected\n  }\n\n  buildRequest(request: RequestBuilder): RequestState {\n    request.setDestinationAddress(this.destinationAddress)\n\n    if (!this.isConnected) {\n      request.addFrames(\n        // Disallow any new streams (and only the client can open stream 1)\n        new ConnectionMaxStreamIdFrame(PaymentSender.DEFAULT_STREAM_ID),\n        // Disallow incoming data\n        new ConnectionMaxDataFrame(0)\n      )\n    }\n\n    return RequestState.Ready()\n  }\n\n  applyRequest(): (reply: StreamReply) => void {\n    return (reply: StreamReply) => {\n      // Ready sending connection limits in each packet until we receive an authenticated response\n      this.isConnected = this.isConnected || reply.isAuthentic()\n    }\n  }\n}\n"]}