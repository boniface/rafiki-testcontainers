"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ConnectionCloser = void 0;
const controllers_1 = require("@interledger/pay/dist/src/controllers");
const packet_1 = require("ilp-protocol-stream/dist/src/packet");
const establishment_1 = require("@interledger/pay/dist/src/controllers/establishment");
const sequence_1 = require("@interledger/pay/dist/src/controllers/sequence");
const expiry_1 = require("@interledger/pay/dist/src/controllers/expiry");
const _1 = require("@interledger/pay/dist/src/senders");
class ConnectionCloser extends _1.StreamSender {
    constructor(plugin, destination) {
        super(plugin, destination);
        this.sentCloseFrame = false;
        this.controllers = [
            new sequence_1.SequenceController(destination.requestCounter),
            new establishment_1.EstablishmentController(destination),
            new expiry_1.ExpiryController(),
        ];
    }
    nextState(request) {
        if (this.sentCloseFrame) {
            return controllers_1.SendState.Yield();
        }
        this.sentCloseFrame = true;
        request.log.debug('trying to send connection close frame.');
        request.addFrames(new packet_1.ConnectionCloseFrame(packet_1.ErrorCode.NoError, ''));
        return controllers_1.SendState.Send(() => controllers_1.SendState.Done(undefined));
    }
}
exports.ConnectionCloser = ConnectionCloser;
//# sourceMappingURL=connection-closer.js.map