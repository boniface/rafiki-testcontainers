{"version":3,"file":"failure.js","sourceRoot":"","sources":["../../../src/controllers/failure.ts"],"names":[],"mappings":";;;AACA,gEAK4C;AAC5C,gDAAkD;AAClD,0BAAiC;AACjC,2CAAqC;AAIrC,MAAa,iBAAiB;IAC5B,YAAY,CAAC,EAAE,GAAG,EAAiB;QACjC,OAAO,CAAC,KAAkB,EAAE,EAAE;;YAC5B,MAAM,UAAU,GAAG,MAAA,KAAK,CAAC,MAAM,0CAAE,IAAI,CACnC,CAAC,KAAK,EAAoD,EAAE,CAC1D,KAAK,CAAC,IAAI,KAAK,kBAAS,CAAC,eAAe;gBACxC,CAAC,KAAK,CAAC,IAAI,KAAK,kBAAS,CAAC,WAAW;oBACnC,KAAK,CAAC,QAAQ,CAAC,MAAM,CAAC,uBAAa,CAAC,iBAAiB,CAAC,CAAC,CAC5D,CAAA;YACD,IAAI,UAAU,EAAE;gBACd,GAAG,CAAC,KAAK,CACP,wEAAwE,EACxE,kBAAS,CAAC,UAAU,CAAC,SAAS,CAAC,EAC/B,UAAU,CAAC,YAAY,CACxB,CAAA;gBACD,OAAO,gBAAY,CAAC,gBAAgB,CAAA;aACrC;YAGD,IAAI,CAAC,KAAK,CAAC,QAAQ,EAAE,EAAE;gBACrB,OAAM;aACP;YACD,MAAM,EAAE,IAAI,EAAE,GAAG,KAAK,CAAC,SAAS,CAAA;YAChC,IACE,IAAI,CAAC,CAAC,CAAC,KAAK,GAAG;gBACf,IAAI,KAAK,qBAAQ,CAAC,oBAAoB;gBACtC,IAAI,KAAK,qBAAQ,CAAC,qBAAqB;gBACvC,IAAI,KAAK,qBAAQ,CAAC,8BAA8B,EAChD;gBACA,OAAM;aACP;YAGD,GAAG,CAAC,KAAK,CAAC,0BAA0B,EAAE,IAAI,CAAC,CAAA;YAC3C,OAAO,gBAAY,CAAC,cAAc,CAAA;QACpC,CAAC,CAAA;IACH,CAAC;CACF;AArCD,8CAqCC","sourcesContent":["import { StreamController } from '.'\nimport {\n  ConnectionCloseFrame,\n  FrameType,\n  ErrorCode,\n  StreamCloseFrame,\n} from 'ilp-protocol-stream/dist/src/packet'\nimport { PaymentSender } from '../senders/payment'\nimport { PaymentError } from '..'\nimport { IlpError } from 'ilp-packet'\nimport { StreamReply, StreamRequest } from '../request'\n\n/** Controller to end a payment on ILP errors */\nexport class FailureController implements StreamController {\n  applyRequest({ log }: StreamRequest): (reply: StreamReply) => PaymentError | void {\n    return (reply: StreamReply) => {\n      const closeFrame = reply.frames?.find(\n        (frame): frame is ConnectionCloseFrame | StreamCloseFrame =>\n          frame.type === FrameType.ConnectionClose ||\n          (frame.type === FrameType.StreamClose &&\n            frame.streamId.equals(PaymentSender.DEFAULT_STREAM_ID))\n      )\n      if (closeFrame) {\n        log.error(\n          'ending payment: receiver closed the connection. reason=%s message=\"%s\"',\n          ErrorCode[closeFrame.errorCode],\n          closeFrame.errorMessage\n        )\n        return PaymentError.ClosedByReceiver\n      }\n\n      // Ignore Fulfills, temporary errors, F08, F99, R01\n      if (!reply.isReject()) {\n        return\n      }\n      const { code } = reply.ilpReject\n      if (\n        code[0] === 'T' ||\n        code === IlpError.F08_AMOUNT_TOO_LARGE ||\n        code === IlpError.F99_APPLICATION_ERROR ||\n        code === IlpError.R01_INSUFFICIENT_SOURCE_AMOUNT\n      ) {\n        return\n      }\n\n      // On any other error, end the payment immediately\n      log.error('ending payment: %s error', code)\n      return PaymentError.ConnectorError\n    }\n  }\n}\n"]}