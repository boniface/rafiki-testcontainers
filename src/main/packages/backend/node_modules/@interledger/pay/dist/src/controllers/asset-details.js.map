{"version":3,"file":"asset-details.js","sourceRoot":"","sources":["../../../src/controllers/asset-details.ts"],"names":[],"mappings":";;;AAAA,gEAA4F;AAE5F,0BAAiC;AAK1B,MAAM,mBAAmB,GAAG,CAAC,CAAM,EAAqB,EAAE,CAC/D,OAAO,CAAC,KAAK,QAAQ,IAAI,CAAC,KAAK,IAAI,IAAI,OAAO,CAAC,CAAC,IAAI,KAAK,QAAQ,IAAI,IAAA,yBAAiB,EAAC,CAAC,CAAC,KAAK,CAAC,CAAA;AADpF,QAAA,mBAAmB,uBACiE;AAE1F,MAAM,iBAAiB,GAAG,CAAC,CAAU,EAAe,EAAE,CAC3D,OAAO,CAAC,KAAK,QAAQ,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,GAAG,IAAI,MAAM,CAAC,SAAS,CAAC,CAAC,CAAC,CAAA;AADvD,QAAA,iBAAiB,qBACsC;AAcpE,MAAa,sBAAsB;IAGjC,YAAY,EAAE,gBAAgB,EAAsB;QAClD,IAAI,CAAC,gBAAgB,GAAG,gBAAgB,CAAA;IAC1C,CAAC;IAED,mBAAmB;QACjB,OAAO,IAAI,CAAC,gBAAgB,CAAA;IAC9B,CAAC;IAED,YAAY;QACV,OAAO,CAAC,EAAE,MAAM,EAAE,GAAG,EAAe,EAAE,EAAE;YACtC,MAAM,eAAe,GAAG,CAAC,MAAM,aAAN,MAAM,cAAN,MAAM,GAAI,EAAE,CAAC;iBACnC,MAAM,CACL,CAAC,KAAK,EAAwC,EAAE,CAC9C,KAAK,CAAC,IAAI,KAAK,kBAAS,CAAC,sBAAsB,CAClD;iBACA,GAAG,CACF,CAAC,KAAK,EAAgB,EAAE,CAAC,CAAC;gBACxB,IAAI,EAAE,KAAK,CAAC,eAAe;gBAC3B,KAAK,EAAE,KAAK,CAAC,gBAAgB;aAC9B,CAAC,CACH,CAAA;YAEH,KAAK,MAAM,EAAE,IAAI,EAAE,SAAS,EAAE,KAAK,EAAE,UAAU,EAAE,IAAI,eAAe,EAAE;gBAEpE,IAAI,CAAC,IAAI,CAAC,gBAAgB,EAAE;oBAC1B,GAAG,CAAC,KAAK,CAAC,sCAAsC,EAAE,SAAS,EAAE,UAAU,CAAC,CAAA;oBAGxE,IAAI,CAAC,gBAAgB,GAAG;wBACtB,IAAI,EAAE,SAAS;wBACf,KAAK,EAAE,UAAU;qBAClB,CAAA;iBACF;qBAEI,IACH,IAAI,CAAC,gBAAgB,CAAC,IAAI,KAAK,SAAS;oBACxC,IAAI,CAAC,gBAAgB,CAAC,KAAK,KAAK,UAAU,EAC1C;oBACA,GAAG,CAAC,KAAK,CACP,mFAAmF,EACnF,IAAI,CAAC,gBAAgB,CAAC,IAAI,EAC1B,IAAI,CAAC,gBAAgB,CAAC,KAAK,EAC3B,SAAS,EACT,UAAU,CACX,CAAA;oBACD,OAAO,gBAAY,CAAC,wBAAwB,CAAA;iBAC7C;aACF;QACH,CAAC,CAAA;IACH,CAAC;CACF;AArDD,wDAqDC","sourcesContent":["import { ConnectionAssetDetailsFrame, FrameType } from 'ilp-protocol-stream/dist/src/packet'\nimport { StreamController } from '.'\nimport { PaymentError } from '..'\nimport { PaymentDestination } from '../open-payments'\nimport { StreamReply } from '../request'\n\n// eslint-disable-next-line @typescript-eslint/explicit-module-boundary-types, @typescript-eslint/no-explicit-any\nexport const isValidAssetDetails = (o: any): o is AssetDetails =>\n  typeof o === 'object' && o !== null && typeof o.code === 'string' && isValidAssetScale(o.scale)\n\nexport const isValidAssetScale = (o: unknown): o is number =>\n  typeof o === 'number' && o >= 0 && o <= 255 && Number.isInteger(o)\n\n/** Asset and denomination of an Interledger account */\nexport interface AssetDetails {\n  /** Precision of the asset denomination: number of decimal places of the normal unit */\n  scale: number\n  /** Asset code or symbol identifying the currency of the account */\n  code: string\n}\n\n/**\n * Track destination asset details from the STREAM receiver and\n * check for conflicts with existing asset details\n */\nexport class AssetDetailsController implements StreamController {\n  private destinationAsset?: AssetDetails\n\n  constructor({ destinationAsset }: PaymentDestination) {\n    this.destinationAsset = destinationAsset\n  }\n\n  getDestinationAsset(): AssetDetails | undefined {\n    return this.destinationAsset\n  }\n\n  applyRequest(): (reply: StreamReply) => PaymentError | void {\n    return ({ frames, log }: StreamReply) => {\n      const newAssetDetails = (frames ?? [])\n        .filter(\n          (frame): frame is ConnectionAssetDetailsFrame =>\n            frame.type === FrameType.ConnectionAssetDetails\n        )\n        .map(\n          (frame): AssetDetails => ({\n            code: frame.sourceAssetCode,\n            scale: frame.sourceAssetScale,\n          })\n        )\n\n      for (const { code: assetCode, scale: assetScale } of newAssetDetails) {\n        // Only set destination details if we don't already know them\n        if (!this.destinationAsset) {\n          log.debug('got destination asset details: %s %s', assetCode, assetScale)\n          // Packet deserialization should already ensure the asset scale is limited to u8:\n          // https://github.com/interledgerjs/ilp-protocol-stream/blob/8551fd498f1ff313da72f63891b9fa428212c31a/src/packet.ts#L274\n          this.destinationAsset = {\n            code: assetCode,\n            scale: assetScale,\n          }\n        }\n        // If the destination asset details changed, end the payment\n        else if (\n          this.destinationAsset.code !== assetCode ||\n          this.destinationAsset.scale !== assetScale\n        ) {\n          log.error(\n            'ending payment: remote unexpectedly changed destination asset from %s %s to %s %s',\n            this.destinationAsset.code,\n            this.destinationAsset.scale,\n            assetCode,\n            assetScale\n          )\n          return PaymentError.DestinationAssetConflict\n        }\n      }\n    }\n  }\n}\n"]}