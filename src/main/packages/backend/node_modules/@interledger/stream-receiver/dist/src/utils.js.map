{"version":3,"file":"utils.js","sourceRoot":"","sources":["../../src/utils.ts"],"names":[],"mappings":"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","sourcesContent":["import { Frame, Packet } from 'ilp-protocol-stream/dist/src/packet'\nimport Long from 'long'\nimport { IlpPacketType, IlpAddress, IlpFulfill, IlpReject, IlpErrorCode } from 'ilp-packet'\nimport { longFromValue, LongValue } from 'ilp-protocol-stream/dist/src/util/long'\nimport { createHmac, createHash, createCipheriv, createDecipheriv } from 'crypto'\nimport { randomBytes } from 'ilp-protocol-stream/dist/src/crypto'\n\nconst HASH_ALGORITHM = 'sha256'\nconst ENCRYPTION_ALGORITHM = 'aes-256-gcm'\nconst IV_LENGTH = 12\nconst AUTH_TAG_LENGTH = 16\n\nexport const sha256 = (preimage: Buffer): Buffer =>\n  createHash(HASH_ALGORITHM).update(preimage).digest()\n\nexport const hmac = (key: Buffer, message: Buffer): Buffer =>\n  createHmac(HASH_ALGORITHM, key).update(message).digest()\n\nexport const encrypt = (key: Buffer, plaintext: Buffer): Buffer => {\n  const iv = randomBytes(12)\n  const cipher = createCipheriv(ENCRYPTION_ALGORITHM, key, iv)\n\n  const ciphertext = []\n  ciphertext.push(cipher.update(plaintext))\n  ciphertext.push(cipher.final())\n  const tag = cipher.getAuthTag()\n  ciphertext.unshift(iv, tag)\n  return Buffer.concat(ciphertext)\n}\n\nexport const decrypt = (key: Buffer, ciphertext: Buffer): Buffer => {\n  const nonce = ciphertext.slice(0, IV_LENGTH)\n\n  // Buffer#slice is a reference to the same Buffer, but Node.js 10\n  // throws an internal OpenSSL error if the auth tag uses the same\n  // Buffer as the ciphertext, so copy to a new Buffer instead.\n  const tag = Buffer.alloc(AUTH_TAG_LENGTH)\n  ciphertext.copy(tag, 0, IV_LENGTH, IV_LENGTH + AUTH_TAG_LENGTH)\n\n  const encrypted = ciphertext.slice(IV_LENGTH + AUTH_TAG_LENGTH)\n  const decipher = createDecipheriv(ENCRYPTION_ALGORITHM, key, nonce)\n  decipher.setAuthTag(tag)\n\n  return Buffer.concat([decipher.update(encrypted), decipher.final()])\n}\n\nexport const base64url = (buffer: Buffer): string =>\n  buffer.toString('base64').replace(/=+$/, '').replace(/\\+/g, '-').replace(/\\//g, '_')\n\n/** Construct an ILP Fulfill or ILP Reject with a STREAM packet */\nexport class ReplyBuilder {\n  private encryptionKey?: Buffer\n  private sequence = Long.UZERO\n  private receivedAmount = Long.UZERO\n  private frames: Frame[] = []\n  private ilpAddress = ''\n\n  setIlpAddress(ilpAddress: IlpAddress): this {\n    this.ilpAddress = ilpAddress\n    return this\n  }\n\n  setEncryptionKey(key: Buffer): this {\n    this.encryptionKey = key\n    return this\n  }\n\n  setSequence(sequence: Long): this {\n    this.sequence = sequence\n    return this\n  }\n\n  setReceivedAmount(receivedAmount: LongValue): this {\n    this.receivedAmount = longFromValue(receivedAmount, true)\n    return this\n  }\n\n  addFrames(...frames: Frame[]): this {\n    this.frames.push(...frames)\n    return this\n  }\n\n  private buildData(type: IlpPacketType): Buffer {\n    if (!this.encryptionKey) {\n      return Buffer.alloc(0)\n    }\n\n    const streamPacket = new Packet(\n      this.sequence,\n      +type,\n      this.receivedAmount,\n      this.frames\n    )._serialize()\n    return encrypt(this.encryptionKey, streamPacket)\n  }\n\n  buildFulfill(fulfillment: Buffer): IlpFulfill {\n    return {\n      fulfillment,\n      data: this.buildData(IlpPacketType.Fulfill),\n    }\n  }\n\n  buildReject(code: IlpErrorCode): IlpReject {\n    return {\n      code,\n      message: '',\n      triggeredBy: this.ilpAddress,\n      data: this.buildData(IlpPacketType.Reject),\n    }\n  }\n}\n"]}