{"version":3,"file":"sequence.js","sourceRoot":"","sources":["../../../src/controllers/sequence.ts"],"names":[],"mappings":";;;AAAA,wBAAkD;AAClD,0BAAiC;AAEjC,oCAAmE;AAEnE,MAAa,OAAO;IAClB,YAA4B,KAAyB;QAAzB,UAAK,GAAL,KAAK,CAAoB;IAAG,CAAC;IAEzD,MAAM,CAAC,IAAI,CAAC,KAAa;QACvB,IAAI,IAAA,4BAAoB,EAAC,KAAK,CAAC,EAAE;YAC/B,OAAO,IAAI,OAAO,CAAC,KAAK,CAAC,CAAA;SAC1B;IACH,CAAC;IAED,SAAS;QACP,IAAI,CAAC,KAAK,EAAE,CAAA;IACd,CAAC;IAED,QAAQ;QACN,OAAO,IAAI,CAAC,KAAK,CAAA;IACnB,CAAC;CACF;AAhBD,0BAgBC;AAGD,MAAa,kBAAkB;IAG7B,YAA6B,OAAgB;QAAhB,YAAO,GAAP,OAAO,CAAS;IAAG,CAAC;IAEjD,YAAY,CAAC,OAAuB;QAGlC,IAAI,IAAI,CAAC,OAAO,CAAC,QAAQ,EAAE,IAAI,kBAAkB,CAAC,YAAY,EAAE;YAC9D,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,yDAAyD,CAAC,CAAA;YAC5E,OAAO,eAAY,CAAC,KAAK,CAAC,gBAAY,CAAC,sBAAsB,CAAC,CAAA;SAC/D;aAAM;YACL,OAAO,CAAC,WAAW,CAAC,IAAI,CAAC,OAAO,CAAC,QAAQ,EAAE,CAAC,CAAA;YAC5C,OAAO,eAAY,CAAC,KAAK,EAAE,CAAA;SAC5B;IACH,CAAC;IAED,YAAY;QACV,IAAI,CAAC,OAAO,CAAC,SAAS,EAAE,CAAA;QACxB,OAAM;IACR,CAAC;;AApBH,gDAqBC;AApBgB,+BAAY,GAAG,CAAC,CAAC,IAAI,EAAE,CAAuB,CAAA","sourcesContent":["import { RequestState, StreamController } from '.'\nimport { PaymentError } from '..'\nimport { RequestBuilder } from '../request'\nimport { isNonNegativeInteger, NonNegativeInteger } from '../utils'\n\nexport class Counter {\n  private constructor(private count: NonNegativeInteger) {}\n\n  static from(count: number): Counter | undefined {\n    if (isNonNegativeInteger(count)) {\n      return new Counter(count)\n    }\n  }\n\n  increment(): void {\n    this.count++\n  }\n\n  getCount(): NonNegativeInteger {\n    return this.count\n  }\n}\n\n/** Track the sequence number of outgoing packets */\nexport class SequenceController implements StreamController {\n  private static PACKET_LIMIT = (2 ** 31) as NonNegativeInteger\n\n  constructor(private readonly counter: Counter) {}\n\n  buildRequest(request: RequestBuilder): RequestState {\n    // Destroy the connection after 2^31 packets are sent for encryption safety:\n    // https://github.com/interledger/rfcs/blob/master/0029-stream/0029-stream.md#513-maximum-number-of-packets-per-connection\n    if (this.counter.getCount() >= SequenceController.PACKET_LIMIT) {\n      request.log.error('ending payment: cannot exceed max safe sequence number.')\n      return RequestState.Error(PaymentError.MaxSafeEncryptionLimit)\n    } else {\n      request.setSequence(this.counter.getCount())\n      return RequestState.Ready()\n    }\n  }\n\n  applyRequest(): undefined {\n    this.counter.increment()\n    return // Required by TS for `undefined` return type\n  }\n}\n"]}