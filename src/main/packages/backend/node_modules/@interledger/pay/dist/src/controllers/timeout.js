"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TimeoutController = void 0;
const _1 = require("@interledger/pay/dist/src/controllers");
const __1 = require("@interledger/pay");
class TimeoutController {
    buildRequest(request) {
        if (this.deadline && Date.now() > this.deadline) {
            request.log.error('ending payment: no fulfill received before idle deadline.');
            return _1.RequestState.Error(__1.PaymentError.IdleTimeout);
        }
        else {
            return _1.RequestState.Ready();
        }
    }
    applyRequest() {
        if (!this.deadline) {
            this.resetDeadline();
        }
        return (reply) => {
            if (reply.isFulfill()) {
                this.resetDeadline();
            }
        };
    }
    resetDeadline() {
        this.deadline = Date.now() + TimeoutController.MAX_DURATION_SINCE_LAST_FULFILL;
    }
}
exports.TimeoutController = TimeoutController;
TimeoutController.MAX_DURATION_SINCE_LAST_FULFILL = 10000;
//# sourceMappingURL=timeout.js.map