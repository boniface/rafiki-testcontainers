{"version":3,"file":"connection-closer.js","sourceRoot":"","sources":["../../../src/senders/connection-closer.ts"],"names":[],"mappings":";;;AAAA,gDAA4D;AAC5D,gEAAqF;AACrF,gEAAsE;AACtE,sDAA4D;AAC5D,kDAAwD;AAExD,wBAAgC;AAIhC,MAAa,gBAAiB,SAAQ,eAAkB;IAKtD,YAAY,MAAc,EAAE,WAA4B;QACtD,KAAK,CAAC,MAAM,EAAE,WAAW,CAAC,CAAA;QALpB,mBAAc,GAAG,KAAK,CAAA;QAO5B,IAAI,CAAC,WAAW,GAAG;YACjB,IAAI,6BAAkB,CAAC,WAAW,CAAC,cAAc,CAAC;YAClD,IAAI,uCAAuB,CAAC,WAAW,CAAC;YACxC,IAAI,yBAAgB,EAAE;SACvB,CAAA;IACH,CAAC;IAED,SAAS,CAAC,OAAuB;QAC/B,IAAI,IAAI,CAAC,cAAc,EAAE;YACvB,OAAO,uBAAS,CAAC,KAAK,EAAE,CAAA;SACzB;QACD,IAAI,CAAC,cAAc,GAAG,IAAI,CAAA;QAC1B,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,wCAAwC,CAAC,CAAA;QAE3D,OAAO,CAAC,SAAS,CAAC,IAAI,6BAAoB,CAAC,kBAAS,CAAC,OAAO,EAAE,EAAE,CAAC,CAAC,CAAA;QAElE,OAAO,uBAAS,CAAC,IAAI,CAAC,GAAG,EAAE,CAEzB,uBAAS,CAAC,IAAI,CAAC,SAAS,CAAC,CAC1B,CAAA;IACH,CAAC;CACF;AA7BD,4CA6BC","sourcesContent":["import { SendState, StreamController } from '../controllers'\nimport { ConnectionCloseFrame, ErrorCode } from 'ilp-protocol-stream/dist/src/packet'\nimport { EstablishmentController } from '../controllers/establishment'\nimport { SequenceController } from '../controllers/sequence'\nimport { ExpiryController } from '../controllers/expiry'\nimport { Plugin, RequestBuilder } from '../request'\nimport { StreamSender } from '.'\nimport { ResolvedPayment } from '..'\n\n/** Send a best-effort `ConnectionClose` frame if necessary, and resolve if it was sent */\nexport class ConnectionCloser extends StreamSender<void> {\n  private sentCloseFrame = false\n\n  protected readonly controllers: StreamController[]\n\n  constructor(plugin: Plugin, destination: ResolvedPayment) {\n    super(plugin, destination)\n\n    this.controllers = [\n      new SequenceController(destination.requestCounter),\n      new EstablishmentController(destination),\n      new ExpiryController(),\n    ]\n  }\n\n  nextState(request: RequestBuilder): SendState<void> {\n    if (this.sentCloseFrame) {\n      return SendState.Yield() // Don't schedule another attempt\n    }\n    this.sentCloseFrame = true\n    request.log.debug('trying to send connection close frame.')\n\n    request.addFrames(new ConnectionCloseFrame(ErrorCode.NoError, ''))\n\n    return SendState.Send(() =>\n      // After request completes, finish send loop\n      SendState.Done(undefined)\n    )\n  }\n}\n"]}