const Client = require('knex/lib/client');
const QueryBuilder = require('knex/lib/query/querybuilder');
const QueryInterface = require('knex/lib/query/method-constants');

const makeKnex = require('knex/lib/knex-builder/make-knex');
const { KnexTimeoutError } = require('knex/lib/util/timeout');
const { resolveConfig } = require('knex/lib/knex-builder/internal/config-resolver');
const SchemaBuilder = require('knex/lib/schema/builder');
const ViewBuilder = require('knex/lib/schema/viewbuilder');
const ColumnBuilder = require('knex/lib/schema/columnbuilder');
const TableBuilder = require('knex/lib/schema/tablebuilder');

function knex(config) {
  const { resolvedConfig, Dialect } = resolveConfig(...arguments);

  const newKnex = makeKnex(new Dialect(resolvedConfig));
  if (resolvedConfig.userParams) {
    newKnex.userParams = resolvedConfig.userParams;
  }
  return newKnex;
}

// Expose Client on the main Knex namespace.
knex.Client = Client;

knex.KnexTimeoutError = KnexTimeoutError;

knex.QueryBuilder = {
  extend: function (methodName, fn) {
    QueryBuilder.extend(methodName, fn);
    QueryInterface.push(methodName);
  },
};

knex.SchemaBuilder = {
  extend: function (methodName, fn) {
    SchemaBuilder.extend(methodName, fn);
  },
};

knex.ViewBuilder = {
  extend: function (methodName, fn) {
    ViewBuilder.extend(methodName, fn);
  },
};

knex.ColumnBuilder = {
  extend: function (methodName, fn) {
    ColumnBuilder.extend(methodName, fn);
  },
};

knex.TableBuilder = {
  extend: function (methodName, fn) {
    TableBuilder.extend(methodName, fn);
  },
};

module.exports = knex;
